#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 2 ]]; then
  echo "Usage: fence-run MODE PROBE_NAME" >&2
  exit 1
fi

script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)
repo_root=$(cd "${script_dir}/.." >/dev/null 2>&1 && pwd)
helpers_lib="${repo_root}/tools/lib/helpers.sh"
if [[ ! -f "${helpers_lib}" ]]; then
  echo "fence-run: missing helpers library at ${helpers_lib}" >&2
  exit 1
fi
# shellcheck source=tools/lib/helpers.sh
source "${helpers_lib}"

mode="$1"
probe_name="$2"
probe_path=$(resolve_probe_script_path "${repo_root}" "${probe_name}" || true)

if [[ -z "${probe_path}" ]]; then
  echo "Probe not found: ${probe_name}" >&2
  exit 1
fi

if [[ ! -x "${probe_path}" ]]; then
  if [[ -f "${probe_path}" ]]; then
    chmod +x "${probe_path}" 2>/dev/null || true
  fi
fi

if [[ ! -x "${probe_path}" ]]; then
  echo "Probe not found or not executable: ${probe_path}" >&2
  exit 1
fi

sandbox_requires_codex() {
  if ! command -v codex >/dev/null 2>&1; then
    echo "codex CLI not found; mode '${mode}' requires codex. Install codex or run baseline instead." >&2
    exit 1
  fi
}

sandbox_mode=""
run_cmd=()
case "${mode}" in
  baseline)
    sandbox_mode=""
    run_cmd=("${probe_path}")
    ;;
  codex-sandbox)
    sandbox_requires_codex
    sandbox_mode="workspace-write"
    platform=$(uname -s)
    case "${platform}" in
      Darwin)
        run_cmd=(codex sandbox macos --full-auto -- "${probe_path}")
        ;;
      Linux)
        run_cmd=(codex sandbox linux --full-auto -- "${probe_path}")
        ;;
      *)
        echo "Unsupported platform for codex-sandbox: ${platform}" >&2
        exit 1
        ;;
    esac
    ;;
  codex-full)
    sandbox_mode="danger-full-access"
    # TODO: wire up dedicated codex profile that disables sandboxing entirely.
    run_cmd=("${probe_path}")
    ;;
  *)
    echo "Unknown mode: ${mode}" >&2
    exit 1
    ;;
esac

FENCE_RUN_MODE="${mode}" FENCE_SANDBOX_MODE="${sandbox_mode}" "${run_cmd[@]}"

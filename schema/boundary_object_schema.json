{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/Protonk/fencerunner/schema/boundary_object_schema.json",
  "title": "Fencerunner Boundary Event (v1 pattern)",
  "description": "Generalized boundary-event structure for probe executions aligned with a capability catalog. The pattern version is carried via schema_version; the concrete schema key is carried via schema_key.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "schema_key",
    "capabilities_schema_version",
    "stack",
    "probe",
    "run",
    "operation",
    "result",
    "payload",
    "capability_context"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "boundary_event_v1",
      "description": "Boundary-event pattern version."
    },
    "schema_key": {
      "type": "string",
      "description": "Boundary schema key chosen by the descriptor (e.g., cfbo-v1).",
      "pattern": "^[A-Za-z0-9_.-]+$"
    },
    "capabilities_schema_version": {
      "description": "The catalog key from the capability catalog used when interpreting capability ids (e.g., \"macOS_codex_v1\").",
      "type": "string",
      "pattern": "^[A-Za-z0-9_.-]+$"
    },
    "stack": {
      "type": "object",
      "additionalProperties": false,
      "required": ["os"],
      "properties": {
        "sandbox_mode": {
          "type": ["string", "null"],
          "enum": ["read-only", "workspace-write", "danger-full-access", null]
        },
        "os": { "type": "string" }
      }
    },
    "probe": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "version",
        "primary_capability_id",
        "secondary_capability_ids"
      ],
      "properties": {
        "id": { "type": "string" },
        "version": { "type": "string" },
        "primary_capability_id": { "type": "string" },
        "secondary_capability_ids": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        }
      }
    },
    "run": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mode",
        "workspace_root",
        "command"
      ],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["baseline"]
        },
        "workspace_root": { "type": ["string", "null"] },
        "command": { "type": "string" }
      }
    },
    "operation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "category",
        "verb",
        "target",
        "args"
      ],
      "properties": {
        "category": {
          "type": "string",
          "description": "High-level operation category (e.g., filesystem, process, network)."
        },
        "verb": {
          "type": "string",
          "description": "Concrete verb for the attempted operation (e.g., open, execve, connect)."
        },
        "target": {
          "type": "string",
          "description": "Primary target of the operation (e.g., path, host:port, command)."
        },
        "args": {
          "type": "object",
          "description": "Probe-specific arguments or parameters associated with the operation."
        }
      }
    },
    "result": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "observed_result",
        "raw_exit_code",
        "errno",
        "message",
        "error_detail"
      ],
      "properties": {
        "observed_result": {
          "type": "string",
          "enum": ["success", "denied", "partial", "error"]
        },
        "raw_exit_code": { "type": ["integer", "null"] },
        "errno": { "type": ["string", "null"] },
        "message": { "type": ["string", "null"] },
        "error_detail": { "type": ["string", "null"] }
      }
    },
    "payload": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stdout_snippet", "stderr_snippet", "raw"],
      "properties": {
        "stdout_snippet": { "type": ["string", "null"] },
        "stderr_snippet": { "type": ["string", "null"] },
        "raw": {
          "type": "object",
          "description": "Probe-specific raw output or structured data for deeper analysis."
        }
      }
    },
    "capability_context": {
      "type": "object",
      "description": "Snapshot of the primary and secondary capabilities as interpreted from the active capability catalog at the time of the run.",
      "additionalProperties": false,
      "required": ["primary"],
      "properties": {
        "primary": {
          "$ref": "#/definitions/capability_snapshot"
        },
        "secondary": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/capability_snapshot"
          },
          "uniqueItems": true
        }
      }
    }
  },
  "definitions": {
    "capability_snapshot": {
      "type": "object",
      "description": "Minimal snapshot of a capability from the capability catalog used by this probe.",
      "additionalProperties": false,
      "required": ["id", "category", "layer"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Capability ID (e.g., cap_fs_read_git_metadata)."
        },
        "category": {
          "type": "string",
          "description": "Capability category (e.g., filesystem, process, network, sandbox_profile, agent_sandbox_policy)."
        },
        "layer": {
          "type": "string",
          "description": "Layer at which the capability exists (e.g., os_sandbox, agent_runtime)."
        }
      }
    }
  }
}

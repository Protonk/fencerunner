#!/usr/bin/env bash
set -euo pipefail

# Entry point for running probes under different sandbox modes. Preserve the CLI
# contract (MODE PROBE_NAME) because other tooling shells out directly. Keep the
# detection logic hermetic—no extra deps or repos—and prefer readability over
# cleverness so agents can audit how probes are launched.

usage() {
  cat >&2 <<'USAGE'
Usage: fence-run [--workspace-root PATH] MODE PROBE_NAME

Overrides:
  --workspace-root PATH   Export PATH via FENCE_WORKSPACE_ROOT (defaults to repo root).
                          Pass an empty string to defer to emit-record's git/pwd fallback.

Environment:
  FENCE_WORKSPACE_ROOT    When set, takes precedence over the default repo root export.
USAGE
  exit 1
}

cli_workspace_root_override_set=0
cli_workspace_root_override_value=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --workspace-root)
      if [[ $# -lt 2 ]]; then
        echo "Missing path for --workspace-root" >&2
        usage
      fi
      cli_workspace_root_override_set=1
      cli_workspace_root_override_value="$2"
      shift 2
      ;;
    --workspace-root=*)
      cli_workspace_root_override_set=1
      cli_workspace_root_override_value="${1#*=}"
      shift
      ;;
    -h|--help)
      usage
      ;;
    --*)
      echo "Unknown option: $1" >&2
      usage
      ;;
    *)
      break
      ;;
  esac
done

if [[ $# -ne 2 ]]; then
  usage
fi

script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)
repo_root=$(cd "${script_dir}/.." >/dev/null 2>&1 && pwd)
portable_path_helper="${repo_root}/bin/portable-path"
if [[ ! -x "${portable_path_helper}" ]]; then
  echo "portable-path helper not found at ${portable_path_helper}. Build it with 'cargo build --release'." >&2
  exit 1
fi

portable_realpath() {
  "${portable_path_helper}" realpath "$1"
}

canonicalize_workspace_root() {
  local candidate="$1"
  local resolved
  resolved=$(portable_realpath "${candidate}")
  if [[ -n "${resolved}" ]]; then
    printf '%s\n' "${resolved}"
  else
    printf '%s\n' "${candidate}"
  fi
}

workspace_root=$(portable_realpath "${repo_root}")
if [[ -z "${workspace_root}" ]]; then
  workspace_root="${repo_root}"
fi

env_workspace_root_override_set=0
env_workspace_root_override_value=""
if [[ "${FENCE_WORKSPACE_ROOT+x}" == x ]]; then
  env_workspace_root_override_set=1
  env_workspace_root_override_value="${FENCE_WORKSPACE_ROOT}"
fi

should_export_workspace_root=1
export_workspace_root=""
if [[ ${cli_workspace_root_override_set} -eq 1 ]]; then
  if [[ -n "${cli_workspace_root_override_value}" ]]; then
    export_workspace_root=$(canonicalize_workspace_root "${cli_workspace_root_override_value}")
  else
    should_export_workspace_root=0
  fi
elif [[ ${env_workspace_root_override_set} -eq 1 ]]; then
  if [[ -n "${env_workspace_root_override_value}" ]]; then
    export_workspace_root=$(canonicalize_workspace_root "${env_workspace_root_override_value}")
  else
    should_export_workspace_root=0
  fi
else
  export_workspace_root="${workspace_root}"
fi

# Resolve a user-supplied probe identifier to a script under workspace_root/probes.
resolve_probe_script_path() {
  local repo="$1"
  local identifier="$2"
  local attempts=() candidate trimmed canonical_path
  if [[ -z "${identifier}" ]]; then
    return 1
  fi
  if [[ "${identifier}" == /* ]]; then
    attempts+=("${identifier}")
  else
    trimmed=${identifier#./}
    attempts+=("${repo}/${trimmed}")
    if [[ "${trimmed}" != *.sh ]]; then
      attempts+=("${repo}/${trimmed}.sh")
    fi
    attempts+=("${repo}/probes/${trimmed}")
    if [[ "${trimmed}" != *.sh ]]; then
      attempts+=("${repo}/probes/${trimmed}.sh")
    fi
  fi
  for candidate in "${attempts[@]}"; do
    if [[ -f "${candidate}" ]]; then
      canonical_path=$(portable_realpath "${candidate}")
      if [[ -n "${canonical_path}" && "${canonical_path}" == "${repo}/probes/"* ]]; then
        printf '%s\n' "${canonical_path}"
        return 0
      fi
    fi
  done
  return 1
}
mode="$1"
probe_name="$2"
probe_path=$(resolve_probe_script_path "${workspace_root}" "${probe_name}" || true)

# Protect against typos early so callers see a friendly error.
if [[ -z "${probe_path}" ]]; then
  echo "Probe not found: ${probe_name}" >&2
  exit 1
fi

if [[ ! -x "${probe_path}" ]]; then
  if [[ -f "${probe_path}" ]]; then
    echo "Probe is not executable: ${probe_path}" >&2
  else
    echo "Probe not found or not executable: ${probe_path}" >&2
  fi
  exit 1
fi

# Ensure we refuse sandbox modes that require the codex CLI unless it exists.
sandbox_requires_codex() {
  if ! command -v codex >/dev/null 2>&1; then
    echo "codex CLI not found; mode '${mode}' requires codex. Install codex or run baseline instead." >&2
    exit 1
  fi
}

# Determine how the probe should run based on the requested mode.
sandbox_mode=""
run_cmd=()
case "${mode}" in
  baseline)
    sandbox_mode=""
    run_cmd=("${probe_path}")
    ;;
  codex-sandbox)
    sandbox_requires_codex
    sandbox_mode="workspace-write"
    platform=$(uname -s)
    case "${platform}" in
      Darwin)
        run_cmd=(codex sandbox macos --full-auto -- "${probe_path}")
        ;;
      Linux)
        run_cmd=(codex sandbox linux --full-auto -- "${probe_path}")
        ;;
      *)
        echo "Unsupported platform for codex-sandbox: ${platform}" >&2
        exit 1
        ;;
    esac
    ;;
  codex-full)
    sandbox_requires_codex
    sandbox_mode="danger-full-access"
    platform=$(uname -s)
    case "${platform}" in
      Darwin)
        run_cmd=(codex --dangerously-bypass-approvals-and-sandbox sandbox macos -- "${probe_path}")
        ;;
      Linux)
        run_cmd=(codex --dangerously-bypass-approvals-and-sandbox sandbox linux -- "${probe_path}")
        ;;
      *)
        echo "Unsupported platform for codex-full: ${platform}" >&2
        exit 1
        ;;
    esac
    ;;
  *)
    echo "Unknown mode: ${mode}" >&2
    exit 1
    ;;
esac

# Export the mode details in env vars so downstream scripts understand context.
if [[ ${should_export_workspace_root} -eq 1 ]]; then
  FENCE_RUN_MODE="${mode}" FENCE_SANDBOX_MODE="${sandbox_mode}" FENCE_WORKSPACE_ROOT="${export_workspace_root}" "${run_cmd[@]}"
else
  FENCE_RUN_MODE="${mode}" FENCE_SANDBOX_MODE="${sandbox_mode}" "${run_cmd[@]}"
fi
